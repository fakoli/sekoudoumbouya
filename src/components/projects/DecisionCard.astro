---
/**
 * DecisionCard Component
 * Structured summary of project thinking process
 * Shows: Problem â†’ Constraints â†’ Tradeoffs â†’ Outcome â†’ Artifact
 * Enhanced with schematic styling: reference numbers, dashed dividers
 * Supports 'full' (default) and 'compact' variants
 */

interface Tradeoff {
	option: string;
	pros: string[];
	cons: string[];
	chosen: boolean;
}

interface Artifact {
	type: 'doc' | 'code' | 'diagram' | 'dashboard';
	title: string;
	url?: string;
	preview?: string;
}

interface Props {
	problem: string;
	constraints: string[];
	tradeoffs?: Tradeoff[];
	outcome?: {
		summary: string;
		metrics?: Array<{ value: string; label: string }>;
	};
	artifact?: Artifact;
	variant?: 'full' | 'compact';
}

const { problem, constraints, tradeoffs, outcome, artifact, variant = 'full' } = Astro.props;

const isCompact = variant === 'compact';

// Artifact type icons (text-based for reliability)
const artifactIcons: Record<string, string> = {
	doc: 'ðŸ“„',
	code: 'ðŸ’»',
	diagram: 'ðŸ“Š',
	dashboard: 'ðŸ“ˆ',
};

// Section reference numbers
let refNumber = 0;
const getRef = () => ++refNumber;
---

<div class:list={['decision-card', { 'decision-card-compact': isCompact }]}>
	<!-- Problem Section -->
	<div class="decision-card-section">
		<div class="decision-card-label">
			<span class="ref-marker" aria-hidden="true">{getRef()}</span>
			Problem
		</div>
		<div class="decision-card-content">
			{isCompact ? (
				<p class="line-clamp-2">{problem}</p>
			) : (
				problem
			)}
		</div>
	</div>

	<!-- Constraints Section -->
	{!isCompact && (
		<div class="decision-card-section decision-card-section-dashed">
			<div class="decision-card-label">
				<span class="ref-marker" aria-hidden="true">{getRef()}</span>
				Constraints
			</div>
			<ul class="space-y-2">
				{constraints.map((constraint) => (
					<li class="flex items-start gap-2 text-secondary body-sm">
						<span class="text-muted shrink-0">â€¢</span>
						{constraint}
					</li>
				))}
			</ul>
		</div>
	)}

	<!-- Tradeoffs Section (if provided, full variant only) -->
	{!isCompact && tradeoffs && tradeoffs.length > 0 && (
		<div class="decision-card-section decision-card-section-dashed">
			<div class="decision-card-label">
				<span class="ref-marker" aria-hidden="true">{getRef()}</span>
				Tradeoffs Considered
			</div>
			<div class="space-y-4 mt-3">
				{tradeoffs.map((tradeoff) => (
					<div
						class:list={[
							'p-4 rounded-md border',
							tradeoff.chosen
								? 'bg-[var(--schematic-annotation-bg)] border-[var(--color-accent)]'
								: 'bg-[var(--color-bg)] border-[var(--border-subtle)]'
						]}
					>
						<div class="flex items-center justify-between mb-2">
							<span class="font-medium text-foreground body-sm">
								{tradeoff.option}
							</span>
							{tradeoff.chosen && (
								<span class="badge badge-accent text-xs">Chosen</span>
							)}
						</div>
						<div class="grid grid-cols-2 gap-4 mt-3">
							<div>
								<span class="label text-green-600 dark:text-green-400 block mb-1">Pros</span>
								<ul class="space-y-1">
									{tradeoff.pros.map((pro) => (
										<li class="body-sm text-muted flex items-start gap-1">
											<span class="text-green-600 dark:text-green-400 shrink-0">+</span>
											{pro}
										</li>
									))}
								</ul>
							</div>
							<div>
								<span class="label text-red-600 dark:text-red-400 block mb-1">Cons</span>
								<ul class="space-y-1">
									{tradeoff.cons.map((con) => (
										<li class="body-sm text-muted flex items-start gap-1">
											<span class="text-red-600 dark:text-red-400 shrink-0">âˆ’</span>
											{con}
										</li>
									))}
								</ul>
							</div>
						</div>
					</div>
				))}
			</div>
		</div>
	)}

	<!-- Outcome Section (if provided) -->
	{outcome && (
		<div class:list={[
			'decision-card-section',
			{ 'decision-card-section-dashed': !isCompact },
			'bg-[var(--schematic-annotation-bg)]'
		]}>
			<div class="decision-card-label">
				{!isCompact && <span class="ref-marker" aria-hidden="true">{getRef()}</span>}
				Outcome
			</div>
			<div class="decision-card-content font-medium text-foreground">
				{isCompact ? (
					<p class="line-clamp-1">{outcome.summary}</p>
				) : (
					outcome.summary
				)}
			</div>
			{!isCompact && outcome.metrics && outcome.metrics.length > 0 && (
				<div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-4">
					{outcome.metrics.map((metric) => (
						<div class="metric-block">
							<span class="metric-block-value">{metric.value}</span>
							<span class="metric-block-label">{metric.label}</span>
						</div>
					))}
				</div>
			)}
		</div>
	)}

	<!-- Artifact Link (if provided, full variant only) -->
	{!isCompact && artifact && (
		<div class="decision-card-section decision-card-section-accent">
			<div class="decision-card-label">
				<span class="ref-marker" aria-hidden="true">{getRef()}</span>
				Supporting Artifact
			</div>
			<div class="flex items-center gap-3 mt-2">
				<span class="text-2xl">{artifactIcons[artifact.type]}</span>
				<div class="flex-1">
					<div class="font-medium text-foreground body-sm">
						{artifact.title}
					</div>
					<div class="label capitalize">{artifact.type}</div>
				</div>
				{artifact.url && (
					<a
						href={artifact.url}
						target="_blank"
						rel="noopener noreferrer"
						class="btn btn-secondary text-xs"
					>
						View â†’
					</a>
				)}
			</div>
			{artifact.preview && (
				<div class="mt-3 rounded-md overflow-hidden border border-[var(--border-default)]">
					<img
						src={artifact.preview}
						alt={artifact.title}
						class="w-full h-auto"
						loading="lazy"
					/>
				</div>
			)}
		</div>
	)}
</div>

<style>
	/* Enhanced Decision Card with schematic styling */
	.decision-card {
		background: var(--color-surface);
		border: 1px solid var(--border-default);
		border-radius: var(--radius-lg);
		overflow: hidden;
	}

	.decision-card-section {
		padding: var(--space-4) var(--space-6);
		border-bottom: 1px solid var(--border-subtle);
	}

	.decision-card-section:last-child {
		border-bottom: none;
	}

	/* Dashed section divider - schematic style */
	.decision-card-section-dashed {
		border-bottom-style: dashed;
		border-bottom-color: var(--schematic-line);
	}

	/* Accent top border for artifact section */
	.decision-card-section-accent {
		border-top: 2px solid var(--color-accent);
	}

	.decision-card-label {
		display: flex;
		align-items: center;
		gap: var(--space-2);
		font-family: var(--font-mono);
		font-size: 11px;
		font-weight: 500;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--color-muted);
		margin-bottom: var(--space-2);
	}

	.decision-card-content {
		font-size: 15px;
		line-height: 1.6;
		color: var(--color-secondary);
	}

	/* Compact variant */
	.decision-card-compact {
		border-radius: var(--radius-md);
	}

	.decision-card-compact .decision-card-section {
		padding: var(--space-3) var(--space-4);
	}

	.decision-card-compact .decision-card-label {
		font-size: 10px;
		margin-bottom: var(--space-1);
	}

	.decision-card-compact .decision-card-label .ref-marker {
		display: none;
	}

	.decision-card-compact .decision-card-content {
		font-size: 14px;
		line-height: 1.5;
	}
</style>
