---
import ImpactMetric from './ImpactMetric.astro';

interface Props {
	id: string;
	communication?: {
		summary: string;
		highlights: string[];
	};
	behavior?: {
		summary: string;
		highlights: string[];
	};
	impact?: {
		summary: string;
		metrics: Array<{
			value: string;
			label: string;
			context?: string;
		}>;
	};
}

const { id, communication, behavior, impact } = Astro.props;

const tabs = [
	{ key: 'communication', label: 'Communication', data: communication },
	{ key: 'behavior', label: 'Behavior', data: behavior },
	{ key: 'impact', label: 'Impact', data: impact },
].filter(tab => tab.data);
---

<div class="narrative-tabs" data-tabs-id={id}>
	<div class="narrative-tabs-nav" role="tablist">
		{tabs.map((tab, index) => (
			<button
				type="button"
				role="tab"
				class={`narrative-tab-btn ${index === 0 ? 'active' : ''}`}
				data-tab={tab.key}
				aria-selected={index === 0 ? 'true' : 'false'}
				aria-controls={`${id}-${tab.key}-panel`}
				id={`${id}-${tab.key}-tab`}
			>
				{tab.label}
			</button>
		))}
	</div>

	<div class="narrative-tabs-content">
		{tabs.map((tab, index) => (
			<div
				id={`${id}-${tab.key}-panel`}
				role="tabpanel"
				aria-labelledby={`${id}-${tab.key}-tab`}
				class={`narrative-tab-panel ${index === 0 ? 'active' : ''}`}
				data-tab-panel={tab.key}
				aria-hidden={index === 0 ? 'false' : 'true'}
				tabindex={index === 0 ? '0' : '-1'}
				hidden={index !== 0}
			>
				{tab.key === 'impact' && tab.data && 'metrics' in tab.data ? (
					<>
						<p class="narrative-summary">{tab.data.summary}</p>
						<div class="impact-metrics-grid">
							{tab.data.metrics.map(metric => (
								<ImpactMetric
									value={metric.value}
									label={metric.label}
									context={metric.context}
								/>
							))}
						</div>
					</>
				) : tab.data && 'highlights' in tab.data ? (
					<>
						<p class="narrative-summary">{tab.data.summary}</p>
						<ul class="narrative-highlights">
							{tab.data.highlights.map(highlight => (
								<li>{highlight}</li>
							))}
						</ul>
					</>
				) : null}
			</div>
		))}
	</div>
</div>

<script>
	function initTabs() {
		document.querySelectorAll<HTMLElement>('.narrative-tabs').forEach(tabsContainer => {
			if (tabsContainer.dataset.initialized === 'true') return;
			tabsContainer.dataset.initialized = 'true';

			const buttons = Array.from(tabsContainer.querySelectorAll<HTMLButtonElement>('.narrative-tab-btn'));
			const panels = Array.from(tabsContainer.querySelectorAll<HTMLElement>('.narrative-tab-panel'));

			const activateTab = (tabKey: string | null, selectedButton?: HTMLButtonElement) => {
				if (!tabKey) return;

				buttons.forEach(btn => {
					const isSelected = btn === selectedButton;
					btn.classList.toggle('active', isSelected);
					btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
				});

				panels.forEach(panel => {
					const isActive = panel.getAttribute('data-tab-panel') === tabKey;
					panel.classList.toggle('active', isActive);
					panel.hidden = !isActive;
					panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
					panel.setAttribute('tabindex', isActive ? '0' : '-1');
				});
			};

			buttons.forEach(button => {
				button.addEventListener('click', () => {
					activateTab(button.getAttribute('data-tab'), button);
				});

				button.addEventListener('keydown', (e) => {
					const currentIndex = buttons.indexOf(button);
					let newIndex = currentIndex;

					if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
						e.preventDefault();
						newIndex = currentIndex === 0 ? buttons.length - 1 : currentIndex - 1;
					} else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
						e.preventDefault();
						newIndex = currentIndex === buttons.length - 1 ? 0 : currentIndex + 1;
					} else if (e.key === 'Home') {
						e.preventDefault();
						newIndex = 0;
					} else if (e.key === 'End') {
						e.preventDefault();
						newIndex = buttons.length - 1;
					}

					if (newIndex !== currentIndex) {
						buttons[newIndex].click();
						buttons[newIndex].focus();
					}
				});
			});
		});
	}

	initTabs();
	document.addEventListener('astro:page-load', initTabs);
</script>
