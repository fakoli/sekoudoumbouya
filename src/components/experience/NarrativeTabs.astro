---
import ImpactMetric from './ImpactMetric.astro';

interface Props {
	id: string;
	communication?: {
		summary: string;
		highlights: string[];
	};
	behavior?: {
		summary: string;
		highlights: string[];
	};
	impact?: {
		summary: string;
		metrics: Array<{
			value: string;
			label: string;
			context?: string;
		}>;
	};
}

const { id, communication, behavior, impact } = Astro.props;

const tabs = [
	{ key: 'communication', label: 'Communication', data: communication },
	{ key: 'behavior', label: 'Behavior', data: behavior },
	{ key: 'impact', label: 'Impact', data: impact },
].filter(tab => tab.data);
---

<div class="narrative-tabs" data-tabs-id={id}>
	<div class="narrative-tabs-nav" role="tablist">
		{tabs.map((tab, index) => (
			<button
				type="button"
				role="tab"
				class={`narrative-tab-btn ${index === 0 ? 'active' : ''}`}
				data-tab={tab.key}
				aria-selected={index === 0 ? 'true' : 'false'}
				aria-controls={`${id}-${tab.key}-panel`}
				id={`${id}-${tab.key}-tab`}
			>
				{tab.label}
			</button>
		))}
	</div>

	<div class="narrative-tabs-content">
		{tabs.map((tab, index) => (
			<div
				id={`${id}-${tab.key}-panel`}
				role="tabpanel"
				aria-labelledby={`${id}-${tab.key}-tab`}
				class={`narrative-tab-panel ${index === 0 ? 'active' : ''}`}
				data-tab-panel={tab.key}
				tabindex="0"
			>
				{tab.key === 'impact' && tab.data && 'metrics' in tab.data ? (
					<>
						<p class="narrative-summary">{tab.data.summary}</p>
						<div class="impact-metrics-grid">
							{tab.data.metrics.map(metric => (
								<ImpactMetric
									value={metric.value}
									label={metric.label}
									context={metric.context}
								/>
							))}
						</div>
					</>
				) : tab.data && 'highlights' in tab.data ? (
					<>
						<p class="narrative-summary">{tab.data.summary}</p>
						<ul class="narrative-highlights">
							{tab.data.highlights.map(highlight => (
								<li>{highlight}</li>
							))}
						</ul>
					</>
				) : null}
			</div>
		))}
	</div>
</div>

<script>
	function initTabs() {
		document.querySelectorAll('.narrative-tabs').forEach(tabsContainer => {
			const buttons = tabsContainer.querySelectorAll('.narrative-tab-btn');
			const panels = tabsContainer.querySelectorAll('.narrative-tab-panel');

			buttons.forEach(button => {
				button.addEventListener('click', () => {
					const tabKey = button.getAttribute('data-tab');

					// Update buttons
					buttons.forEach(btn => {
						btn.classList.remove('active');
						btn.setAttribute('aria-selected', 'false');
					});
					button.classList.add('active');
					button.setAttribute('aria-selected', 'true');

					// Update panels
					panels.forEach(panel => {
						panel.classList.remove('active');
						if (panel.getAttribute('data-tab-panel') === tabKey) {
							panel.classList.add('active');
						}
					});
				});

				// Keyboard navigation
				button.addEventListener('keydown', (e) => {
					const btns = Array.from(buttons);
					const currentIndex = btns.indexOf(button);
					let newIndex = currentIndex;

					if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
						e.preventDefault();
						newIndex = currentIndex === 0 ? btns.length - 1 : currentIndex - 1;
					} else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
						e.preventDefault();
						newIndex = currentIndex === btns.length - 1 ? 0 : currentIndex + 1;
					} else if (e.key === 'Home') {
						e.preventDefault();
						newIndex = 0;
					} else if (e.key === 'End') {
						e.preventDefault();
						newIndex = btns.length - 1;
					}

					if (newIndex !== currentIndex) {
						(btns[newIndex] as HTMLButtonElement).click();
						(btns[newIndex] as HTMLButtonElement).focus();
					}
				});
			});
		});
	}

	// Initialize on page load
	initTabs();

	// Re-initialize on Astro page transitions
	document.addEventListener('astro:page-load', initTabs);
</script>
