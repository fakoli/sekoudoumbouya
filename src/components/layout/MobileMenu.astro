---
/**
 * Mobile navigation menu component
 */
import { SOCIAL_LINKS, NAV_LINKS, RESUME_PATH } from '../../config';
import { withBasePath, isActivePath } from '../../utils/paths';
import LinkedInIcon from '../icons/LinkedInIcon.astro';
import GitHubIcon from '../icons/GitHubIcon.astro';
import MenuIcon from '../icons/MenuIcon.astro';
import CloseIcon from '../icons/CloseIcon.astro';

interface Props {
	currentPath: string;
}

const { currentPath } = Astro.props;
const resumeHref = withBasePath(RESUME_PATH);
---

<button
	type="button"
	class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-[var(--border-default)] text-muted transition-colors hover:bg-[var(--color-bg)] hover:text-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent)] md:hidden"
	aria-controls="mobile-menu"
	aria-expanded="false"
	data-mobile-toggle
>
	<span class="sr-only">Toggle menu</span>
	<span data-icon-open><MenuIcon /></span>
	<span class="hidden" data-icon-close><CloseIcon /></span>
</button>

<nav id="mobile-menu" class="hidden md:hidden border-t border-[var(--border-default)] bg-[var(--color-surface)] absolute left-0 right-0 top-full" aria-label="Mobile navigation" aria-hidden="true">
	<div class="container mx-auto px-4 py-4 space-y-1">
		{NAV_LINKS.map((link) => (
			<a
				href={withBasePath(link.href)}
				class={`block rounded-md px-3 py-3 text-base font-medium transition-colors ${
					isActivePath(currentPath, withBasePath(link.href))
						? 'bg-[var(--color-bg)] text-foreground'
						: 'text-secondary hover:bg-[var(--color-bg)] hover:text-foreground'
				}`}
				data-mobile-link
			>
				{link.label}
			</a>
		))}
		<a
			href={resumeHref}
			target="_blank"
			rel="noopener noreferrer"
			class="block rounded-md border border-[var(--border-strong)] bg-[var(--color-bg)] px-3 py-3 text-base font-medium text-foreground transition-colors hover:bg-[var(--color-foreground)] hover:text-[var(--color-surface)]"
			data-mobile-link
		>
			Resume
		</a>
		<div class="flex items-center gap-4 pt-4">
			<a
				href={SOCIAL_LINKS.linkedin}
				target="_blank"
				rel="noopener noreferrer"
				class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-[var(--border-default)] text-muted transition-colors hover:bg-[var(--color-bg)] hover:text-[#0077b5]"
				aria-label="LinkedIn profile"
				data-mobile-link
			>
				<LinkedInIcon />
			</a>
			<a
				href={SOCIAL_LINKS.github}
				target="_blank"
				rel="noopener noreferrer"
				class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-[var(--border-default)] text-muted transition-colors hover:bg-[var(--color-bg)] hover:text-foreground"
				aria-label="GitHub profile"
				data-mobile-link
			>
				<GitHubIcon />
			</a>
			<button
				type="button"
				class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-[var(--border-default)] text-muted transition-colors hover:bg-[var(--color-bg)] hover:text-foreground"
				aria-label="Toggle theme"
				data-mobile-theme-toggle
			>
				<!-- Sun icon (shown in dark mode) -->
				<svg
					class="mobile-sun-icon w-5 h-5 hidden"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
					stroke-width="2"
				>
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
				</svg>
				<!-- Moon icon (shown in light mode) -->
				<svg
					class="mobile-moon-icon w-5 h-5"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
					stroke-width="2"
				>
					<path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
				</svg>
			</button>
		</div>
	</div>
</nav>

<script>
	function initMobileMenu() {
		const menuButton = document.querySelector<HTMLButtonElement>('[data-mobile-toggle]');
		const mobileMenu = document.getElementById('mobile-menu');
		if (!menuButton || !mobileMenu) return;
		if (menuButton.dataset.initialized === 'true') return;
		menuButton.dataset.initialized = 'true';

		const lockScroll = () => {
			document.body.style.overflow = 'hidden';
		};

		const unlockScroll = () => {
			document.body.style.overflow = '';
		};

		const closeMenu = () => {
			menuButton.setAttribute('aria-expanded', 'false');
			menuButton.querySelector('[data-icon-open]')?.classList.remove('hidden');
			menuButton.querySelector('[data-icon-close]')?.classList.add('hidden');
			mobileMenu.classList.add('hidden');
			mobileMenu.setAttribute('aria-hidden', 'true');
			unlockScroll();

			document.removeEventListener('keydown', handleEscapeKey);
			document.removeEventListener('click', handleClickOutside, true);
			mobileMenu.removeEventListener('keydown', handleFocusTrap);
		};

		const openMenu = () => {
			menuButton.setAttribute('aria-expanded', 'true');
			menuButton.querySelector('[data-icon-open]')?.classList.add('hidden');
			menuButton.querySelector('[data-icon-close]')?.classList.remove('hidden');
			mobileMenu.classList.remove('hidden');
			mobileMenu.setAttribute('aria-hidden', 'false');
			lockScroll();

			const firstLink = mobileMenu.querySelector<HTMLElement>('[data-mobile-link]');
			firstLink?.focus();

			document.addEventListener('keydown', handleEscapeKey);
			document.addEventListener('click', handleClickOutside, true);
			mobileMenu.addEventListener('keydown', handleFocusTrap);
		};

		const handleEscapeKey = (e: KeyboardEvent) => {
			if (e.key === 'Escape') {
				closeMenu();
				menuButton.focus();
			}
		};

		const handleClickOutside = (e: MouseEvent) => {
			const target = e.target as Node;
			if (mobileMenu.classList.contains('hidden')) return;
			if (mobileMenu.contains(target) || menuButton.contains(target)) return;
			closeMenu();
		};

		const handleFocusTrap = (e: KeyboardEvent) => {
			if (e.key !== 'Tab') return;

			const focusableElements = mobileMenu.querySelectorAll<HTMLElement>(
				'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
			);
			if (focusableElements.length === 0) return;

			const firstEl = focusableElements[0];
			const lastEl = focusableElements[focusableElements.length - 1];

			if (e.shiftKey && document.activeElement === firstEl) {
				e.preventDefault();
				lastEl.focus();
			} else if (!e.shiftKey && document.activeElement === lastEl) {
				e.preventDefault();
				firstEl.focus();
			}
		};

		menuButton.addEventListener('click', () => {
			const isOpen = menuButton.getAttribute('aria-expanded') === 'true';
			if (isOpen) {
				closeMenu();
			} else {
				openMenu();
			}
		});

		mobileMenu.querySelectorAll('[data-mobile-link]').forEach((link) => {
			link.addEventListener('click', closeMenu);
		});

		document.querySelector('[data-mobile-theme-toggle]')?.addEventListener('click', () => {
			const win = window as typeof window & { toggleTheme?: () => void; updateAllToggleIcons?: () => void };
			if (typeof win.toggleTheme === 'function') {
				win.toggleTheme();
			}
		});

		const initMobileIcons = () => {
			const win = window as typeof window & { toggleTheme?: () => void; updateAllToggleIcons?: () => void };
			if (typeof win.updateAllToggleIcons === 'function') {
				win.updateAllToggleIcons();
			} else {
				setTimeout(initMobileIcons, 50);
			}
		};

		initMobileIcons();
		document.addEventListener('astro:before-swap', closeMenu);
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initMobileMenu);
	} else {
		initMobileMenu();
	}

	document.addEventListener('astro:page-load', initMobileMenu);
</script>
