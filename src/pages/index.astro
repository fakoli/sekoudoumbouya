---
import PageLayout from '../layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { SITE_CONFIG } from '../config';
import { getBasePath, withBasePath } from '../utils/paths';
import { formatDate } from '../utils/dates';
import { fetchGitHubRepos } from '../utils/github';
import StarIcon from '../components/icons/StarIcon.astro';
import PhilosophyCard from '../components/PhilosophyCard.astro';

const base = getBasePath();

// Fetch Latest Blog Posts
const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});
const latestPosts = posts
	.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
	.slice(0, 3);

// Pinned GitHub repositories
const pinnedRepoNames = [
	"mcp-ai-bridge",
	"AwsSecurityMapper",
	"ai-driven-temporal-to-IAC",
	"xenon-notes",
	"devops-project-skeleton"
];

// Fallback data in case API fetch fails
const fallbackRepos = [
	{
		name: "mcp-ai-bridge",
		full_name: `${SITE_CONFIG.githubUsername}/mcp-ai-bridge`,
		description: "Secure MCP server integrating Claude Code with OpenAI and Google Gemini APIs. Features multi-layer security, content filtering, and rate limiting.",
		html_url: `https://github.com/${SITE_CONFIG.githubUsername}/mcp-ai-bridge`,
		language: "JavaScript",
		stargazers_count: 4,
		topics: ["mcp", "ai", "security", "openai", "gemini"]
	},
	{
		name: "AwsSecurityMapper",
		full_name: `${SITE_CONFIG.githubUsername}/AwsSecurityMapper`,
		description: "Python tool that visualizes AWS security group relationships with interactive Plotly graphs. Supports multi-region and cross-VPC analysis.",
		html_url: `https://github.com/${SITE_CONFIG.githubUsername}/AwsSecurityMapper`,
		language: "Python",
		stargazers_count: 1,
		topics: ["aws", "security", "visualization", "networking"]
	},
	{
		name: "ai-driven-temporal-to-IAC",
		full_name: `${SITE_CONFIG.githubUsername}/ai-driven-temporal-to-IAC`,
		description: "Temporal-based workflow orchestration for multi-workspace Terraform deployments with dependency resolution and MCP server integration.",
		html_url: `https://github.com/${SITE_CONFIG.githubUsername}/ai-driven-temporal-to-IAC`,
		language: "Go",
		stargazers_count: 2,
		topics: ["temporal", "terraform", "iac", "workflow"]
	},
	{
		name: "xenon-notes",
		full_name: `${SITE_CONFIG.githubUsername}/xenon-notes`,
		description: "AI-powered notetaking app for Apple platforms built with Swift and RealityKit.",
		html_url: `https://github.com/${SITE_CONFIG.githubUsername}/xenon-notes`,
		language: "Swift",
		stargazers_count: 2,
		topics: ["swift", "ai", "ios", "notes"]
	},
	{
		name: "devops-project-skeleton",
		full_name: `${SITE_CONFIG.githubUsername}/devops-project-skeleton`,
		description: "Template repository with Terraform, Ansible, and Kubernetes configurations for bootstrapping DevOps projects.",
		html_url: `https://github.com/${SITE_CONFIG.githubUsername}/devops-project-skeleton`,
		language: "HCL",
		stargazers_count: 0,
		topics: ["terraform", "ansible", "kubernetes", "devops", "template"]
	}
];

// Fetch repository data from GitHub API
const repoData = await fetchGitHubRepos(
	pinnedRepoNames.map(repo => ({ owner: SITE_CONFIG.githubUsername, repo }))
);

// Use live data from API if available, otherwise fallback to static data
const pinnedRepos = repoData.every(repo => repo === null)
	? fallbackRepos
	: repoData.map((repo, index) => {
		return repo || (fallbackRepos[index] || null);
	}).filter(Boolean);

// Updated stats with impact-focused metrics
const stats = [
	{ label: "Years Building at Scale", value: "20+" },
	{ label: "Infrastructure Costs Eliminated", value: "$10M+" },
	{ label: "Engineers Developed to Senior+", value: "20+" },
	{ label: "Regions Architected", value: "4+" },
];

// Leadership philosophy cards
const philosophyCards = [
	{
		title: "Player-Coach Leadership",
		description: "I lead by solving hard problems alongside the team. 40% of my time stays in code and design reviews.",
		icon: "âš¡"
	},
	{
		title: "Platform as Product",
		description: "Internal platforms should treat developers as customers. I build golden-path solutions that reduce cognitive load.",
		icon: "ðŸŽ¯"
	},
	{
		title: "Strategic Translation",
		description: "I bridge engineering and business â€” ensuring technical decisions align with company goals.",
		icon: "ðŸ”—"
	},
	{
		title: "Knowledge Multiplication",
		description: "My success metric: teams more capable after working with me.",
		icon: "ðŸ“ˆ"
	}
];

// Technical focus areas for preview
const focusAreas = [
	{ title: "Platform Engineering", subtitle: "DevEx & Tooling", href: `${base}/about#platform-engineering` },
	{ title: "SRE & Scalability", subtitle: "Reliability at Scale", href: `${base}/about#sre-scalability` },
	{ title: "AI/ML Infrastructure", subtitle: "Observability & Governance", href: `${base}/about#ai-ml-infrastructure` },
	{ title: "Cloud-Native Evolution", subtitle: "State of the Art", href: `${base}/about#cloud-native-evolution` }
];

// External engagement items
const externalEngagement = [
	{ title: "AI with Friends", role: "Podcast Co-host", desc: "Weekly conversations on AI, engineering, and tech culture" },
	{ title: "/dev/color", role: "Active Mentor", desc: "Supporting Black engineers navigating senior-level careers" },
	{ title: "Speaking & Writing", role: "Thought Leadership", desc: "Conference talks and technical posts on cloud architecture" }
];

// Generate initials for fallback images
const initials = SITE_CONFIG.name.split(' ').map(n => n[0]).join('');
---

<PageLayout title={`${SITE_CONFIG.name} | ${SITE_CONFIG.title}`} description={SITE_CONFIG.description}>

	<!-- Hero Section -->
	<section class="py-12 md:py-24 relative overflow-hidden">
		<div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center gap-8 md:gap-12">
			<div class="flex-1 z-10">
				<!-- Mobile-only: Compact intro with headshot + name side-by-side -->
				<div class="flex md:hidden items-center gap-4 mb-6">
					<img
						src={`${base}/headshot.jpg`}
						alt={SITE_CONFIG.name}
						class="w-20 h-20 object-cover rounded-lg border border-[var(--border-default)] shrink-0"
						onerror={`this.src='https://placehold.co/80x80?text=${initials}'`}
					/>
					<div>
						<p class="heading-sm text-foreground">{SITE_CONFIG.name}</p>
						<p class="body-sm text-muted mb-2">{SITE_CONFIG.title}</p>
						{SITE_CONFIG.availableForHire && (
							<span class="status-available">
								<span class="status-dot"></span>
								Available for Hire
							</span>
						)}
					</div>
				</div>

				<!-- Desktop-only: Original name/title row -->
				<div class="hidden md:flex flex-wrap items-center gap-3 mb-6">
					<p class="body-lg font-medium text-secondary">
						{SITE_CONFIG.name} â€” {SITE_CONFIG.title}
					</p>
					{SITE_CONFIG.availableForHire && (
						<span class="status-available">
							<span class="status-dot"></span>
							Available for Principal Roles
						</span>
					)}
				</div>

				<h1 class="text-4xl md:text-6xl font-bold text-foreground tracking-tight mb-8 leading-tight">
					Where architecture <br class="hidden md:block" />
					<span class="text-accent">meets execution.</span>
				</h1>

				<p class="body-lg text-secondary mb-6 max-w-2xl leading-relaxed">
					Principal-level infrastructure leader with <strong class="text-foreground">20+ years</strong> building resilient, cost-efficient cloud platforms. I operate at the intersection of hands-on engineering and strategic architecture â€” designing systems that scale and developing the engineers who run them.
				</p>

				<p class="body-md text-muted mb-10 max-w-2xl border-l-2 border-[var(--color-accent)] pl-4 italic">
					TL;DR: I'm best leveraged as a player-coach in organizations navigating multi-region architecture, platform engineering, or AI infrastructure at scale.
				</p>

				<div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
					<a href={withBasePath('/experience')} class="btn btn-primary w-full sm:w-auto">
						View Experience
					</a>
					<a href={withBasePath('/projects')} class="btn btn-secondary w-full sm:w-auto">
						See Case Studies
					</a>
				</div>
			</div>

			<!-- Desktop-only: Large decorative headshot -->
			<div class="hidden md:block w-64 h-64 md:w-80 md:h-80 shrink-0 relative">
				<div class="absolute inset-0 bg-gradient-to-tr from-[var(--color-accent-bg)] to-[var(--color-bg)] rounded-full blur-2xl opacity-70"></div>
				<img
					src={`${base}/headshot.jpg`}
					alt={SITE_CONFIG.name}
					class="w-full h-full object-cover rounded-xl border border-[var(--border-default)] relative z-10 transition-transform duration-300 hover:scale-[1.02]"
					onerror={`this.src='https://placehold.co/400x400?text=${initials}'`}
				/>
			</div>
		</div>
	</section>

	<!-- Quick Navigation -->
	<section class="max-w-6xl mx-auto mb-24 px-4">
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
			{[
				{ href: '#my-projects', title: 'Featured Projects', description: 'Open source tools and applications I build' },
				{ href: withBasePath('/experience'), title: 'Career Timeline', description: '20+ years building cloud infrastructure at scale' },
				{ href: '#insights', title: 'Technical Insights', description: 'Writing on systems design, infrastructure leadership, and AI workloads' }
			].map((item) => (
				<a href={item.href} class="group card p-5 flex items-start gap-3">
					<span class="h-10 w-10 rounded-md bg-[var(--color-accent-bg)] text-accent flex items-center justify-center font-bold group-hover:bg-[var(--color-accent)] group-hover:text-white transition-colors">â†’</span>
					<div>
						<h3 class="font-semibold text-foreground mb-1 group-hover:text-accent transition-colors">{item.title}</h3>
						<p class="body-sm text-muted leading-snug">{item.description}</p>
					</div>
				</a>
			))}
		</div>
	</section>

	<!-- Key Stats Grid -->
	<section class="max-w-6xl mx-auto grid grid-cols-2 sm:grid-cols-4 gap-8 mb-24 border-b border-[var(--border-default)] pb-12 px-4">
		{stats.map(stat => (
			<div>
				<div class="text-4xl md:text-5xl font-bold text-foreground mb-2 tabular-nums">{stat.value}</div>
				<div class="label">{stat.label}</div>
			</div>
		))}
	</section>

	<!-- How I Work With Teams (Expanded with Philosophy Cards) -->
	<section class="max-w-6xl mx-auto mb-24 px-4">
		<h2 class="heading-lg text-foreground mb-4">How I Work With Teams</h2>
		<p class="body-md text-secondary mb-8 max-w-3xl">
			I partner with engineering organizations as a senior IC, architect, or advisor to untangle complex infrastructure problems and build durable systems and teams.
		</p>

		<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
			{philosophyCards.map(card => (
				<PhilosophyCard title={card.title} description={card.description} icon={card.icon} />
			))}
		</div>
	</section>

	<!-- Technical Focus Areas Preview -->
	<section id="focus-areas" class="max-w-6xl mx-auto mb-24 px-4">
		<div class="flex justify-between items-end mb-8">
			<div>
				<h2 class="heading-lg text-foreground mb-2">Technical Focus Areas</h2>
				<p class="body-md text-muted">Where I invest my engineering energy.</p>
			</div>
			<a href={`${base}/about#technical-focus-areas`} class="hidden md:inline-flex items-center link body-sm">
				View details &rarr;
			</a>
		</div>

		<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
			{focusAreas.map(area => (
				<a href={area.href} class="group card p-5 text-center">
					<h3 class="heading-sm text-foreground mb-1 group-hover:text-accent transition-colors">{area.title}</h3>
					<p class="body-sm text-muted">{area.subtitle}</p>
				</a>
			))}
		</div>

		<div class="mt-6 md:hidden">
			<a href={`${base}/about#technical-focus-areas`} class="link body-sm">
				View details &rarr;
			</a>
		</div>
	</section>

	<!-- External Engagement Preview -->
	<section id="external-engagement" class="max-w-6xl mx-auto mb-24 px-4">
		<div class="flex justify-between items-end mb-8">
			<div>
				<h2 class="heading-lg text-foreground mb-2">External Engagement</h2>
				<p class="body-md text-muted">Thought leadership and community.</p>
			</div>
			<a href={`${base}/about#external-engagement`} class="hidden md:inline-flex items-center link body-sm">
				Learn more &rarr;
			</a>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
			{externalEngagement.map(item => (
				<div class="card p-5">
					<div class="badge badge-accent text-xs mb-3">{item.role}</div>
					<h3 class="heading-sm text-foreground mb-2">{item.title}</h3>
					<p class="body-sm text-secondary">{item.desc}</p>
				</div>
			))}
		</div>

		<div class="mt-6 md:hidden">
			<a href={`${base}/about#external-engagement`} class="link body-sm">
				Learn more &rarr;
			</a>
		</div>
	</section>

	<!-- My Projects (Pinned Repos) -->
	<section id="my-projects" class="max-w-6xl mx-auto mb-24 px-4">
		<div class="flex justify-between items-end mb-12">
			<div>
				<h2 class="heading-lg text-foreground mb-2">My Projects</h2>
				<p class="body-md text-muted">Open source tools and applications I build and maintain.</p>
			</div>
			<a href={`https://github.com/${SITE_CONFIG.githubUsername}?tab=repositories`} class="hidden md:inline-flex items-center link body-sm" target="_blank" rel="noopener noreferrer">
				View all on GitHub &rarr;
			</a>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			{pinnedRepos.map((repo) => (
				<a href={repo.html_url} class="group card p-6 flex flex-col h-full" target="_blank" rel="noopener noreferrer">
					<div class="flex items-center justify-between mb-4">
						<span class="badge badge-accent">
							{repo.full_name.split('/')[0]}
						</span>
						{repo.language && (
							<span class="body-sm text-muted mono">{repo.language}</span>
						)}
					</div>

					<h3 class="heading-sm text-foreground mb-3 group-hover:text-accent transition-colors">
						{repo.name}
					</h3>

					<p class="body-sm text-secondary mb-6 flex-1 leading-relaxed">
						{repo.description || 'No description available'}
					</p>

					<div class="flex flex-wrap gap-2 mt-auto">
						<span class="tag flex items-center gap-1">
							<StarIcon />
							<span class="tabular-nums">{repo.stargazers_count}</span>
						</span>
						{repo.topics?.slice(0, 3).map(topic => (
							<span class="tag">{topic}</span>
						))}
					</div>
				</a>
			))}
		</div>

		<div class="mt-8 md:hidden">
			<a href={`https://github.com/${SITE_CONFIG.githubUsername}?tab=repositories`} class="link body-sm" target="_blank" rel="noopener noreferrer">
				View all on GitHub &rarr;
			</a>
		</div>
	</section>

	<!-- Latest Writing -->
	<section id="insights" class="max-w-4xl mx-auto border-t border-[var(--border-default)] pt-20 px-4">
		<div class="flex justify-between items-baseline mb-12">
			<h2 class="heading-lg text-foreground">Technical Insights</h2>
			<a href={withBasePath('/blog')} class="link body-sm">Read all articles &rarr;</a>
		</div>

		<p class="body-md text-muted mb-10">Selected essays on systems design, infrastructure leadership, and AI workloads.</p>

		<div class="space-y-10">
			{latestPosts.map((post) => (
				<article class="group relative">
					<div class="flex flex-col md:flex-row md:items-baseline md:justify-between mb-2">
						<h3 class="heading-sm text-foreground group-hover:text-accent transition-colors">
							<a href={`${base}/blog/${post.id}`}>
								<span class="absolute inset-0"></span>
								{post.data.title}
							</a>
						</h3>
						<time datetime={post.data.publishDate.toISOString()} class="body-sm text-muted shrink-0 md:ml-4 tabular-nums">
							{formatDate(post.data.publishDate)}
						</time>
					</div>
					<p class="body-md text-secondary mb-3 max-w-2xl">
						{post.data.description}
					</p>
					<div class="flex gap-2 relative z-10">
						{post.data.tags.map(tag => (
							<span class="body-sm text-faint">#{tag}</span>
						))}
					</div>
				</article>
			))}
		</div>
	</section>

	<!-- Work With Me CTA -->
	<section class="bg-[var(--color-bg)] mt-24">
		<div class="max-w-3xl mx-auto px-4 py-12 md:py-16 text-center">
			<h2 class="heading-lg text-foreground mb-4">Interested in working together?</h2>
			<p class="body-lg text-secondary mb-8 leading-relaxed">
				Whether you're hiring, need an advisor, or want to connectâ€”let's talk.
			</p>
			<a href={withBasePath('/contact')} class="btn btn-accent">
				Contact Me
				<span class="ml-1">â†’</span>
			</a>
		</div>
	</section>

</PageLayout>
