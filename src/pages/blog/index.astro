---
import PageLayout from '../../layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { getBasePath, withBasePath } from '../../utils/paths';
import { formatDate } from '../../utils/dates';

const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});
const sortedPosts = posts.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
const base = getBasePath();

// Extract all unique tags
const allTags = [...new Set(sortedPosts.flatMap(post => post.data.tags))].sort();

// Calculate reading time estimate (if not provided in frontmatter)
function estimateReadingTime(content: string): number {
	const wordsPerMinute = 200;
	const words = content.split(/\s+/).length;
	return Math.ceil(words / wordsPerMinute);
}
---

<PageLayout title="Blog | Sekou Doumbouya" description="Thoughts on cloud infrastructure, engineering leadership, and technology.">
	<section class="max-w-3xl mx-auto">
		<!-- Header with RSS link -->
		<div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
			<div>
				<h1 class="heading-xl text-foreground mb-2">Technical Insights</h1>
				<p class="body-lg text-secondary">
					Selected essays on systems design, infrastructure leadership, and AI workloads.
				</p>
			</div>
			<a
				href={withBasePath('/rss.xml')}
				class="inline-flex items-center gap-2 text-muted hover:text-accent transition-colors body-sm shrink-0"
				title="RSS Feed"
			>
				<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
					<path d="M6.18 15.64a2.18 2.18 0 1 1 0 4.36 2.18 2.18 0 0 1 0-4.36m12.18 4.36a14.36 14.36 0 0 0-14.36-14.36V9a11 11 0 0 1 11 11h3.36m-6.72 0a7.64 7.64 0 0 0-7.64-7.64v3.36a4.28 4.28 0 0 1 4.28 4.28h3.36z"/>
				</svg>
				Subscribe via RSS
			</a>
		</div>

		<!-- Tag Filter -->
		{allTags.length > 0 && (
			<div class="mb-8">
				<div class="flex flex-wrap gap-2" id="tag-filters">
					<button
						class="tag-filter tag cursor-pointer hover:bg-[var(--color-accent-bg)] hover:text-accent hover:border-[var(--color-accent)] transition-colors active"
						data-tag="all"
					>
						All Posts
					</button>
					{allTags.map(tag => (
						<button
							class="tag-filter tag cursor-pointer hover:bg-[var(--color-accent-bg)] hover:text-accent hover:border-[var(--color-accent)] transition-colors"
							data-tag={tag}
						>
							#{tag}
						</button>
					))}
				</div>
			</div>
		)}

		<!-- Posts List -->
		<div class="space-y-6" id="posts-list">
			{sortedPosts.map((post, index) => {
				const readingTime = post.data.readingTime || estimateReadingTime(post.body || '');
				const isFirst = index === 0;

				return (
					<article
						class={`group card p-6 post-card ${isFirst ? 'border-l-2 border-l-[var(--color-accent)]' : ''}`}
						data-tags={post.data.tags.join(',')}
					>
						<a href={`${base}/blog/${post.id}`} class="block">
							<div class="flex flex-wrap items-center gap-2 mb-3">
								{isFirst && (
									<span class="badge badge-accent text-xs">Latest</span>
								)}
								<time datetime={post.data.publishDate.toISOString()} class="body-sm text-muted tabular-nums">
									{formatDate(post.data.publishDate)}
								</time>
								<span class="text-faint">Â·</span>
								<span class="body-sm text-muted">{readingTime} min read</span>
							</div>

							<h2 class="heading-sm text-foreground group-hover:text-accent transition-colors mb-2">
								{post.data.title}
							</h2>

							<p class="body-md text-secondary mb-4">
								{post.data.description}
							</p>

							<div class="flex flex-wrap gap-2">
								{post.data.tags.map(tag => (
									<span class="body-sm text-muted">#{tag}</span>
								))}
							</div>
						</a>
					</article>
				);
			})}
		</div>

		<!-- Empty State -->
		<div id="empty-state" class="hidden text-center py-12">
			<p class="text-muted body-lg">No posts found with that tag.</p>
			<button class="link mt-2" id="clear-filter">Show all posts</button>
		</div>
	</section>
</PageLayout>

<style>
	.tag-filter.active {
		background-color: var(--color-accent-bg);
		color: var(--color-accent);
		border-color: var(--color-accent);
	}

	.post-card.hidden {
		display: none;
	}
</style>

<script>
	const tagFilters = document.querySelectorAll('.tag-filter');
	const postCards = document.querySelectorAll('.post-card');
	const emptyState = document.getElementById('empty-state');
	const clearFilter = document.getElementById('clear-filter');

	function filterPosts(tag: string) {
		let visibleCount = 0;

		postCards.forEach((card) => {
			const cardTags = card.getAttribute('data-tags')?.split(',') || [];
			const shouldShow = tag === 'all' || cardTags.includes(tag);

			if (shouldShow) {
				card.classList.remove('hidden');
				visibleCount++;
			} else {
				card.classList.add('hidden');
			}
		});

		// Update active state
		tagFilters.forEach((btn) => {
			if (btn.getAttribute('data-tag') === tag) {
				btn.classList.add('active');
			} else {
				btn.classList.remove('active');
			}
		});

		// Show empty state if no posts
		if (emptyState) {
			emptyState.classList.toggle('hidden', visibleCount > 0);
		}
	}

	tagFilters.forEach((btn) => {
		btn.addEventListener('click', () => {
			const tag = btn.getAttribute('data-tag') || 'all';
			filterPosts(tag);
		});
	});

	clearFilter?.addEventListener('click', () => {
		filterPosts('all');
	});
</script>
