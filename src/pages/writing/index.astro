---
import PageLayout from '../../layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { SITE_CONFIG } from '../../config';
import { getBasePath } from '../../utils/paths';
import { formatDate } from '../../utils/dates';
import { PODCAST_LINKS } from '../../data/podcast';

const base = getBasePath();

// Fetch all blog posts
const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});
const sortedPosts = posts.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// Featured post (most recent or could be manually flagged)
const featuredPost = sortedPosts[0];
const remainingPosts = sortedPosts.slice(1);

// External talks/appearances
const talks = [
	{
		title: 'AI with Friends Podcast',
		type: 'podcast',
		description: 'Weekly conversations on AI, engineering, and tech culture',
		url: PODCAST_LINKS.youtube,
		date: 'Ongoing',
	},
];

// External writing (could be moved to content collection later)
const externalWriting = [
	// Add external guest posts, Medium articles, etc. when available
];
---

<PageLayout title={`Writing & Talks | ${SITE_CONFIG.name}`} description="Technical writing, conference talks, and podcast appearances on infrastructure, platform engineering, and AI.">
	<div class="max-w-4xl mx-auto px-4 py-12">
		<header class="mb-12">
			<h1 class="heading-xl text-foreground mb-4">Writing & Talks</h1>
			<p class="body-lg text-secondary max-w-2xl">
				Technical essays, conference presentations, and podcast appearances on systems design, infrastructure leadership, and AI workloads.
			</p>
		</header>

		<!-- Filter tabs -->
		<nav class="flex gap-4 mb-12 border-b border-[var(--border-default)] pb-4">
			<a href="#blog" class="body-sm font-medium text-foreground border-b-2 border-[var(--color-accent)] pb-4 -mb-[17px]">
				Blog
			</a>
			{talks.length > 0 && (
				<a href="#talks" class="body-sm font-medium text-muted hover:text-foreground transition-colors pb-4 -mb-[17px]">
					Talks
				</a>
			)}
			{externalWriting.length > 0 && (
				<a href="#external" class="body-sm font-medium text-muted hover:text-foreground transition-colors pb-4 -mb-[17px]">
					External
				</a>
			)}
		</nav>

		<!-- Featured Post -->
		{featuredPost && (
			<section class="mb-16">
				<div class="label mb-4">Featured</div>
				<article class="card p-8 border-l-4 border-l-[var(--color-accent)]">
					<div class="flex items-center gap-2 mb-4">
						<time datetime={featuredPost.data.publishDate.toISOString()} class="body-sm text-muted tabular-nums">
							{formatDate(featuredPost.data.publishDate)}
						</time>
						{featuredPost.data.readingTime && (
							<>
								<span class="text-muted">·</span>
								<span class="body-sm text-muted">{featuredPost.data.readingTime} min read</span>
							</>
						)}
					</div>
					<h2 class="heading-md text-foreground mb-3 hover:text-accent transition-colors">
						<a href={`${base}/blog/${featuredPost.id}`}>
							{featuredPost.data.title}
						</a>
					</h2>
					<p class="body-md text-secondary mb-4">
						{featuredPost.data.description}
					</p>
					<div class="flex flex-wrap gap-2 mb-4">
						{featuredPost.data.tags.map(tag => (
							<span class="body-sm text-muted">#{tag}</span>
						))}
					</div>
					<a href={`${base}/blog/${featuredPost.id}`} class="link text-sm font-medium">
						Read article &rarr;
					</a>
				</article>
			</section>
		)}

		<!-- Blog Posts Section -->
		<section id="blog" class="mb-16">
			<h2 class="heading-lg text-foreground mb-8">All Posts</h2>
			<div class="space-y-8">
				{remainingPosts.map((post) => (
					<article class="group">
						<div class="flex flex-col md:flex-row md:items-baseline md:justify-between mb-2">
							<h3 class="heading-sm text-foreground group-hover:text-accent transition-colors">
								<a href={`${base}/blog/${post.id}`}>
									{post.data.title}
								</a>
							</h3>
							<time datetime={post.data.publishDate.toISOString()} class="body-sm text-muted shrink-0 md:ml-4 tabular-nums">
								{formatDate(post.data.publishDate)}
							</time>
						</div>
						<p class="body-md text-secondary mb-2">
							{post.data.description}
						</p>
						<div class="flex gap-2">
							{post.data.tags.map(tag => (
								<span class="body-sm text-faint">#{tag}</span>
							))}
						</div>
					</article>
				))}
			</div>

			{sortedPosts.length === 0 && (
				<p class="body-md text-muted text-center py-12">
					No posts yet. Check back soon.
				</p>
			)}
		</section>

		<!-- Talks Section -->
		{talks.length > 0 && (
			<section id="talks" class="mb-16 border-t border-[var(--border-default)] pt-12">
				<h2 class="heading-lg text-foreground mb-8">Talks & Podcasts</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					{talks.map((talk) => (
						<article class="card p-6">
							<div class="flex items-center gap-2 mb-3">
								<span class="badge badge-accent text-xs">{talk.type}</span>
								<span class="body-sm text-muted">{talk.date}</span>
							</div>
							<h3 class="heading-sm text-foreground mb-2">
								{talk.url !== '#' ? (
									<a href={talk.url} target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors">
										{talk.title}
									</a>
								) : (
									talk.title
								)}
							</h3>
							<p class="body-sm text-secondary">
								{talk.description}
							</p>
						</article>
					))}
				</div>
			</section>
		)}

		<!-- External Writing Section -->
		{externalWriting.length > 0 && (
			<section id="external" class="mb-16 border-t border-[var(--border-default)] pt-12">
				<h2 class="heading-lg text-foreground mb-8">External Writing</h2>
				<div class="space-y-6">
					{externalWriting.map((item: any) => (
						<article class="group">
							<h3 class="heading-sm text-foreground group-hover:text-accent transition-colors">
								<a href={item.url} target="_blank" rel="noopener noreferrer">
									{item.title}
								</a>
							</h3>
							<p class="body-sm text-muted">
								{item.publication} · {item.date}
							</p>
						</article>
					))}
				</div>
			</section>
		)}

		<!-- RSS Feed Link -->
		<div class="border-t border-[var(--border-default)] pt-8">
			<a href={`${base}/rss.xml`} class="link body-sm flex items-center gap-2">
				<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
					<path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
				</svg>
				Subscribe via RSS
			</a>
		</div>
	</div>
</PageLayout>
