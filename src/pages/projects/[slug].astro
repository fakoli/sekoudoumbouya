---
import { getCollection, render } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import { getBasePath } from '../../utils/paths';
import { formatDate } from '../../utils/dates';
import ArrowLeftIcon from '../../components/icons/ArrowLeftIcon.astro';

export async function getStaticPaths() {
	const projects = await getCollection('projects');
	return projects.map((project) => ({
		params: { slug: project.id },
		props: { project, allProjects: projects },
	}));
}

const { project, allProjects } = Astro.props;
const { Content } = await render(project);
const base = getBasePath();

// Get related projects (same category or shared tags, excluding current)
const relatedProjects = allProjects
	.filter(p => p.id !== project.id)
	.filter(p => {
		const sharedTags = p.data.tags.filter(t => project.data.tags.includes(t));
		return p.data.category === project.data.category || sharedTags.length > 0;
	})
	.slice(0, 3);
---

<PageLayout title={`${project.data.title} | Projects`} description={project.data.description}>
	<article class="max-w-4xl mx-auto px-4 py-12">

		<!-- Navigation -->
		<div class="mb-8">
			<a href={`${base}/projects`} class="inline-flex items-center body-sm text-muted hover:text-accent transition-colors">
				<ArrowLeftIcon class="h-4 w-4 mr-1" />
				Back to Projects
			</a>
		</div>

		<!-- Header Section -->
		<header class="mb-16 border-b border-[var(--border-default)] pb-12">
			<div class="flex items-center gap-3 mb-6">
				<span class="badge badge-accent">
					{project.data.organization}
				</span>
				{project.data.featured && (
					<span class="badge badge-featured">
						★ Featured
					</span>
				)}
			</div>

			<h1 class="heading-xl text-foreground mb-8 leading-tight">
				{project.data.title}
			</h1>

			<!-- Impact Summary Box -->
			<div class="bg-[var(--color-bg)] border-l-4 border-[var(--color-accent)] p-6 md:p-8 rounded-r-lg mb-10">
				<h3 class="label mb-2">Impact Summary</h3>
				<p class="body-lg text-foreground font-medium leading-relaxed">
					{project.data.impactSummary}
				</p>
			</div>

			<!-- Metadata Grid -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
				<div>
					<h3 class="label mb-1">Role</h3>
					<p class="body-sm font-medium text-foreground">{project.data.role}</p>
				</div>
				<div>
					<h3 class="label mb-1">Timeline</h3>
					<p class="body-sm font-medium text-foreground tabular-nums">{project.data.duration || formatDate(project.data.publishDate, 'long')}</p>
				</div>
				<div>
					<h3 class="label mb-1">Scale</h3>
					<div class="body-sm font-medium text-foreground">
						{Array.isArray(project.data.scale) ? (
							<ul class="list-none">
								{project.data.scale.map(s => <li>{s}</li>)}
							</ul>
						) : (
							project.data.scale
						)}
					</div>
				</div>
				<div>
					<h3 class="label mb-1">Links</h3>
					<div class="flex flex-col gap-1">
						{project.data.repository && (
							<a href={project.data.repository} target="_blank" class="link body-sm">GitHub &rarr;</a>
						)}
						{project.data.externalLink && (
							<a href={project.data.externalLink} target="_blank" class="link body-sm">Live Site &rarr;</a>
						)}
						{!project.data.repository && !project.data.externalLink && (
							<span class="body-sm text-muted italic">Internal / Confidential</span>
						)}
					</div>
				</div>
			</div>
		</header>

		<!-- Main Content -->
		<div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
			<!-- Sidebar (Tech Stack) -->
			<aside class="lg:col-span-3 order-2 lg:order-1">
				<div class="sticky" style="top: calc(var(--header-height) + 1rem);">
					<h3 class="label mb-4">Tech Stack</h3>
					<div class="flex flex-wrap lg:flex-col gap-2">
						{project.data.primaryTech.map(tech => (
							<span class="tag text-center lg:text-left">
								{tech}
							</span>
						))}
					</div>

					<div class="mt-8">
						<h3 class="label mb-4">Tags</h3>
						<div class="flex flex-wrap gap-2">
							{project.data.tags.map(tag => (
								<span class="body-sm text-muted">#{tag}</span>
							))}
						</div>
					</div>
				</div>
			</aside>

			<!-- MDX Content -->
			<div class="lg:col-span-9 order-1 lg:order-2">
				<div class="prose prose-lg max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-a:no-underline hover:prose-a:underline">
					<Content />
				</div>

				<!-- Key Takeaways Box -->
				{project.data.outcomes && project.data.outcomes.length > 0 && (
					<div class="mt-12 card p-6 md:p-8 bg-[var(--color-accent-bg)] border-[var(--color-accent)]">
						<h3 class="heading-sm text-foreground mb-4 flex items-center gap-2">
							<svg class="w-5 h-5 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
							</svg>
							Key Takeaways
						</h3>
						<ul class="space-y-2">
							{project.data.outcomes.map(outcome => (
								<li class="flex items-start gap-3">
									<span class="text-accent mt-1.5 shrink-0">●</span>
									<span class="body-md text-secondary">{outcome}</span>
								</li>
							))}
						</ul>
					</div>
				)}
			</div>
		</div>

		<!-- Related Projects -->
		{relatedProjects.length > 0 && (
			<section class="mt-16 pt-12 border-t border-[var(--border-default)]">
				<h2 class="heading-md text-foreground mb-8">Related Projects</h2>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
					{relatedProjects.map(related => (
						<a href={`${base}/projects/${related.id}`} class="card p-5 group hover:border-[var(--color-accent)] transition-colors">
							<div class="flex items-center gap-2 mb-2">
								<span class="badge text-xs">{related.data.category === 'open-source' ? 'Open Source' : 'Case Study'}</span>
							</div>
							<h3 class="heading-sm text-foreground group-hover:text-accent transition-colors mb-2">
								{related.data.title}
							</h3>
							<p class="body-sm text-muted line-clamp-2">
								{related.data.description}
							</p>
						</a>
					))}
				</div>
			</section>
		)}

	</article>
</PageLayout>
